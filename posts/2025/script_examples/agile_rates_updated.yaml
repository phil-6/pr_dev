alias: Agile Rates Updated
description: >-
  Compute & store 6 cheapest half-hour slots (with full times & prices), notify
  on change
triggers:
  - event_type: octopus_energy_electricity_next_day_rates
    trigger: event
actions:
  - data:
      notification_id: battery_charge_times
      title: ðŸ”‹ Battery charge times update in progress
      message: |-
        ðŸ•“ Started at: {{ triggered_at }}

        Calculating cheapest slotsâ€¦
    action: persistent_notification.create
  - response_variable: ps_result
    action: python_script.store_battery_charge_times
    data: {}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ not ps_result.changed }}"
        sequence:
          - data:
              notification_id: battery_charge_times
            action: persistent_notification.dismiss
    default:
      - variables:
          slot_msg: |-
            {%- if ps_result.rates_available and ps_result.slots %}
              {%- for slot in ps_result.slots %}
                {{ slot.start | as_timestamp | timestamp_custom('%H:%M') }} â€“ {{ slot.end | as_timestamp | timestamp_custom('%H:%M') }} @ {{ slot.price }} p/kWh
                {%- if not loop.last %}

                {%- endif %}
              {%- endfor %}
            {%- else %}
             ðŸš« Next-day rates not available yet
            
              {%- if ps_result.old_slots_in_progress %}
                ðŸ“ˆ Old Slots Still In Progress
              {%- endif %}
            {%- endif %}
      - data:
          notification_id: battery_charge_times
          title: ðŸ”‹ Battery charge times updated
          message: |-
            ðŸ•“ Ran at: {{ triggered_at }}

            {{ slot_msg }}
        action: persistent_notification.create
      - data:
          title: Tomorrowâ€™s Battery charge times ðŸ”‹
          message: |-
            ðŸ•“ Ran at: {{ triggered_at }}

            {{ slot_msg }}
          data:
            clickAction: /energy-custom/4
        action: notify.mobile_app_device
variables:
  triggered_at: "{{ now() | as_timestamp  | timestamp_custom('%I:%M:%S %p') }}"
mode: single
